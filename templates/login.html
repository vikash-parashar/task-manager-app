<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="../static/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost&family=Urbanist:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/login.css">
</head>

<body>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col col-5">
                <h1>Login</h1>
                <form id="loginForm" class="needs-validation" novalidate>
                    <!-- email field -->
                    <div class="mb-3">
                        <label for="email" class="form-label">Email:</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                        <div class="invalid-feedback">
                            Please enter a valid email address.
                        </div>
                    </div>

                    <!-- Password field with visibility toggle -->
                    <div class="mb-3">
                        <label for="password" class="form-label">Password:</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password" name="password" required>
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword"
                                style="background-color: rgb(255, 255, 255);border-color:#dee2e6;border: 0.800rem;">
                                <i class="bi bi-eye"><img src="../static/images/view.png" alt="img"
                                        style="width: 20px;background-color: rgb(255, 255, 255);"></i><!-- Add an eye icon for visibility toggle -->
                            </button>
                        </div>
                        <div class="invalid-feedback">
                            Please enter your password.
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Login</button>
                </form>

                <p class="ad mt-3">Don't have an account? <a href="/register">Register here</a></p>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>

        // Function to delete a token from local storage
        function deleteAccessToken() {
            localStorage.removeItem('access_token');
        }
        deleteAccessToken()
        $(document).ready(function () {
            // Event delegation for password toggle button
            $('#loginForm').on('click', '#togglePassword', function () {
                togglePasswordVisibility();
            });

            // Event delegation for form submission
            $('#loginForm').on('submit', function (event) {
                event.preventDefault(); // Prevent the default form submission
                handleLoginFormSubmission(this);
            });
        });

        function togglePasswordVisibility() {
            var passwordField = $('#password');
            var passwordFieldType = passwordField.attr('type');
            if (passwordFieldType === 'password') {
                passwordField.attr('type', 'text');
                $('#togglePassword').html('<i class="bi bi-eye-slash"><img src="../static/images/eye.png" alt="img" style="width: 20px;background-color: aliceblue;"></i>'); // Change to an eye-slash icon
            } else {
                passwordField.attr('type', 'password');
                $('#togglePassword').html('<i class="bi bi-eye"><img src="../static/images/view.png" alt="img" style="width: 20px;background-color: aliceblue;"></i>'); // Change back to an eye icon
            }
        }

        // Add a variable to track if a submission is in progress
        var isSubmitting = false;

        function handleLoginFormSubmission(form) {
            // Check if a submission is already in progress
            if (isSubmitting) {
                return;
            }

            isSubmitting = true;

            var email = $('#email').val();
            var password = $('#password').val();

            // Check if email and password are not empty
            if (!email) {
                alert('Please Enter Email !');
                isSubmitting = false; // Reset the flag
                return;
            }

            // Check if email and password are not empty
            if (!password) {
                alert('Please Enter Password !');
                isSubmitting = false; // Reset the flag
                return;
            }

            // Prepare the data to be sent to the API
            var data = {
                email: email,
                password: password,
            };

            // Send a POST request to the Golang backend API for login
            fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then((response) => {
                    if (response.status === 200) {
                        return response.json(); // Parse the JSON from the response
                    }
                })
                .then((jsonResponse) => {
                    if (jsonResponse.status === 'success') {
                        // Store the access token in local storage
                        localStorage.setItem('access_token', jsonResponse.data.access_token);

                        fetch('/todo', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${jsonResponse.data.access_token}`, // Set the auth header
                            },
                        })
                            .then((response) => {
                                return response.text(); // Parse the text (HTML) from the response
                            })
                            .then((htmlResponse) => {
                                // Replace the entire body's HTML with the fetched HTML
                                $('body').html(htmlResponse);
                            });
                    }
                })
                .catch((error) => {
                    // Handle authentication failure or other errors
                    alert('Authentication failed: ' + error.message);
                })
                .finally(() => {
                    isSubmitting = false; // Reset the flag regardless of success or failure
                });
        }


    </script>

</body>

</html>